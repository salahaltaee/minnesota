
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نتيجة الاختبار</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDKSesdZluaV5uzJJTAZ0NdH6TqOGP-YCA",
      authDomain: "minnesota-279cc.firebaseapp.com",
      projectId: "minnesota-279cc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const allAnswers = JSON.parse(localStorage.getItem("answers") || "[]");
    const patientId = localStorage.getItem("patientId");
    const userId = localStorage.getItem("userId");
    const results = [];

    function countAnswers(indices, expected = "نعم") {
      return indices.reduce((sum, idx) => {
        return allAnswers[idx - 1] === expected ? sum + 1 : sum;
      }, 0);
    }

    const lieScale = [15,30,45,60,75,90,105,120,135,150,165,195,225,255,285];
    const lieCount = countAnswers(lieScale, "لا");
    let lieScore = 0;
    if (lieCount <= 2) lieScore = 44;
    else if (lieCount <= 5) lieScore = 52;
    else if (lieCount <= 7) lieScore = 65;
    else lieScore = 75;
    results.push({ name: "مقياس الكذب", score: lieScore });

    const fYes = [15,27,31,34,35,40,42,48,49,50,53,56,66,85,121,123,139,146,151,156,168,184,197,200,202,205,206,209,210,211,215,218,227,245,246,247,252,256,269,275,286,288,291,293];
    const fNo = [17,20,54,65,75,83,112,113,115,164,169,177,185,196,199,220,257,258,272,276];
    const fScore = countAnswers(fYes, "نعم") + countAnswers(fNo, "لا");
    results.push({ name: "مقياس عدم التواتر", score: fScore });

    const container = document.getElementById("results");
    const scales = [
      {
        name: "مقياس التصحيح K",
        yes: [96],
        no: [30,39,71,89,124,129,34,138,142,148,160,170,171,180,183,217,234,267,272,296,316,322,368,374,382,383,392,397,398]
      }
    ];

    scales.forEach(scale => {
      const score = countAnswers(scale.yes || [], "نعم") + countAnswers(scale.no || [], "لا");
      results.push({ name: scale.name, score });
    });

    // عرض النتائج
    results.forEach(item => {
      const card = document.createElement("div");
      card.className = "col-md-4";
      card.innerHTML = `
        <div class="card shadow">
          <div class="card-body">
            <h5 class="card-title">${item.name}</h5>
            <p class="card-text">الدرجة: <strong>${item.score}</strong></p>
          </div>
        </div>
      `;
      container.appendChild(card);
    });

    // حفظ النتائج داخل Firebase
    if (userId && patientId) {
      const resultsRef = collection(db, `psychologists/${userId}/patients/${patientId}/results`);
      await addDoc(resultsRef, {
        results,
        date: new Date()
      });
    }
  </script>
</head>
<body class="bg-light">
  <div class="container my-5">
    <h2 class="text-center mb-4">نتائج المقاييس النفسية</h2>
    <div id="results" class="row g-4"></div>
  </div>
</body>
</html>
